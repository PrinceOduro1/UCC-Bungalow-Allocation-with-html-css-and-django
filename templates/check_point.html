<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment Results</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/points.css' %}">
    <link rel="stylesheet" href="{% static 'css/side.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="sidebar">
        <h3>Hello Admin</h3>
        <ul>
            <li><a href="{% url 'check_point' %}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="{% url 'manage_buildings' %}"><i class="fas fa-building"></i> Manage Buildings</a></li>
            <li><a href="{% url 'view_all_preferences' %}"><i class="fas fa-list-alt"></i> View Preferences</a></li>
            <li><a href="{% url 'view_all_users' %}"><i class="fas fa-users"></i> View Users</a></li>
        </ul>
    </div>
    <main>
        <h1>Assignment Results</h1>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Staff Number</th>
                    <th>Total Points</th>
                    <th>Assigned Building</th>
                </tr>
            </thead>
            <tbody>
                {% with processed_staff_numbers="" %}
                    {% for result in results %}
                        {% if result.staff_number not in processed_staff_numbers %}
                            {% if result.spouse_id %}
                                {% with spouse_result=None %}
                                    {% for r in results %}
                                        {% if r.staff_number == result.spouse_id %}
                                            {% with spouse_result=r %}
                                                {% with combined_points=result.total_points|add:spouse_result.total_points %}
                                                    <tr>
                                                        <td>{{ result.name }} & {{ spouse_result.name }}</td>
                                                        <td>{{ result.staff_number }} & {{ spouse_result.staff_number }}</td>
                                                        <td>{{ combined_points }}</td>
                                                        <td>{{ result.assigned_building }}</td>
                                                    </tr>
                                                {% endwith %}
                                            {% endwith %}
                                            {% with processed_staff_numbers=processed_staff_numbers|stringformat:"s,%s"|add:result.staff_number|stringformat:"s,%s"|add:spouse_result.staff_number %}
                                            {% endwith %}
                                            {% comment %} Break after processing the spouse {% endcomment %}
                                            {% with break=True %}
                                            {% endwith %}
                                        {% endif %}
                                    {% endfor %}
                                {% endwith %}
                            {% else %}
                                <tr>
                                    <td>{{ result.name }}</td>
                                    <td>{{ result.staff_number }}</td>
                                    <td>{{ result.total_points }}</td>
                                    <td>{{ result.assigned_building }}</td>
                                </tr>
                                {% with processed_staff_numbers=processed_staff_numbers|stringformat:"s,%s"|add:result.staff_number %}
                                {% endwith %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endwith %}
            </tbody>
        </table>
    </main>
</body>
</html>
